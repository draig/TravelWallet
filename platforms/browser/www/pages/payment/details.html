<template>
    <div>
        <div class="list">
            <ul>
                <il>
                    <a class="item-link smart-select smart-select-init" data-open-in="popup" data-close-on-select="true"
                       data-searchbar="true" data-searchbar-placeholder="{{contacts.length}} contacts">
                        <select name="for" @change="recalculate" required>
                            <option value="{{user.user_id}}">You</option>
                            {{#each contacts}}
                            <option value="{{contact_id}}">{{name}}</option>
                            {{/each}}
                        </select>
                        <div class="item-content">
                            <div class="item-inner">
                                <div class="item-title">For</div>
                            </div>
                        </div>
                    </a>
                </il>
                <li>
                    <a class="item-link smart-select smart-select-init" data-open-in="popup" data-close-on-select="true">
                        <select name="currency" @change="recalculate" required>
                            {{#each currencies}}
                            <option value="{{this.currency_id}}">{{this.title}}</option>
                            {{/each}}
                        </select>
                        <div class="item-content">
                            <div class="item-inner">
                                <div class="item-title">Currency</div>
                            </div>
                        </div>
                    </a>
                </li>
            </ul>
        </div>
    </div>
</template>

<style>

</style>

<!--suppress JSAnnotator -->
<script>
    var debt, compiledTemplate = Template7.compile($$('#details-template').html());

    function updateDetails() {
        var contact_id = $$('[name="for"]').val();
        var currency_id = $$('[name="currency"]').val();
        $$('#details .generated').remove();
        $$('#details ul').append(compiledTemplate({
            details: service.engine.details(contact_id, debt.debt_id, currency_id),
            currency_id: currency_id
        }));
    }

    return {
        data: function () {
            debt = service.debt.get(this.$route.params.debt_id);
            return {
                currencies: service.currency.getByIds(debt.currency),
                contacts: service.contact.getByIds(debt.participant),
                user: app.data.user
            }
        },
        methods: {
            recalculate: function () {
                updateDetails();
            }
        },
        on: {
            tabMounted: function () {
                updateDetails();
            }
        }
    };
</script>